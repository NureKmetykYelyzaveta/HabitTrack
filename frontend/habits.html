<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HabitTrack ‚Äî –ú–æ—ó –∑–≤–∏—á–∫–∏</title>
    <link rel="stylesheet" href="./style/main.css" />
    <link rel="stylesheet" href="./style/habits.css" />
    <style>
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.8);
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff88;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00cc66;
    }
  </style>
  </head>

  <body>
    <header class="navbar glass">
      <div class="logo">HabitTrack</div>
      <nav class="nav-links">
        <a href="./main.html">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="./habits.html" class="active">–ó–≤–∏—á–∫–∏</a>
        <a href="./stats.html">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        <a href="./archive.html">–ê—Ä—Ö—ñ–≤</a>
      </nav>
      <div class="auth-buttons" id="authButtons"></div>
    </header>

    <main class="section glass habits-section">
      <h1>–ú–æ—ó –∑–≤–∏—á–∫–∏</h1>
      <p class="subtitle">
        –ö–µ—Ä—É–π—Ç–µ —Å–≤–æ—ó–º–∏ –∑–≤–∏—á–∫–∞–º–∏, –≤—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å —ñ —Å—Ç–≤–æ—Ä—é–π—Ç–µ –Ω–æ–≤—ñ —Ü—ñ–ª—ñ –¥–ª—è
        —Å–∞–º–æ—Ä–æ–∑–≤–∏—Ç–∫—É.
      </p>

      <button class="btn btn-fill" id="addHabitBtn">‚ûï –î–æ–¥–∞—Ç–∏ –∑–≤–∏—á–∫—É</button>

      <div class="category-filter" style="display: none">
        <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
        <select id="habitCategory">
          <option value="all">–£—Å—ñ</option>
          <option value="—Å–æ–Ω">–°–æ–Ω</option>
          <option value="—Å–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
          <option value="—Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è</option>
          <option value="—ñ–Ω—à–µ">–Ü–Ω—à–µ</option>
        </select>
      </div>

      <div class="msg error" id="errorMsg" style="display: none;"></div>
      <div class="msg success" id="successMsg" style="display: none;"></div>

      <div class="habits-grid" id="habitsList"></div>
    </main>

    <div class="modal" id="habitModal">
      <div class="modal-content glass">
        <h2 id="modalTitle">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤–∏—á–∫—É</h2>
        <form id="habitForm">
          <input type="hidden" id="habitId" />

          <label>–ù–∞–∑–≤–∞ –∑–≤–∏—á–∫–∏:</label>
          <input
            type="text"
            id="habitName"
            required
            placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –†–∞–Ω–∫–æ–≤–∞ –∑–∞—Ä—è–¥–∫–∞"
          />

          <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
          <select id="habitType" required>
            <option value="—Å–æ–Ω">–°–æ–Ω</option>
            <option value="—Å–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
            <option value="—Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è</option>
            <option value="—ñ–Ω—à–µ">–Ü–Ω—à–µ</option>
          </select>

          <label>–ù–æ—Ç–∞—Ç–∫–∞ (–æ–ø—Ü—ñ–π–Ω–æ):</label>
          <textarea
            id="habitNote"
            placeholder="–î–æ–¥–∞—Ç–∫—ñ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–≤–∏—á–∫—É..."
            rows="3"
          ></textarea>

          <label>–¶—ñ–ª—å (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤):</label>
          <input type="number" id="habitGoal" min="1" max="30" value="7" />

          <label class="complex-label">
            <input type="checkbox" id="isComplex" /> –°–∫–ª–∞–¥–Ω–∞ –∑–≤–∏—á–∫–∞ (–∫—ñ–ª—å–∫–∞
            —Ä–∞–∑—ñ–≤ –Ω–∞ –¥–µ–Ω—å)
          </label>

          <div id="complexSettings" style="display: none">
            <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω—å –Ω–∞ –¥–µ–Ω—å:</label>
            <input type="number" id="repeatCount" min="1" max="10" value="1" />
          </div>

          <div class="modal-buttons">
            <button type="submit" class="btn btn-fill">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button type="button" class="btn btn-outline" id="cancelBtn">
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="noteModal">
      <div class="modal-content glass">
        <h2>–ù–æ—Ç–∞—Ç–∫–∞ –¥–æ –∑–≤–∏—á–∫–∏</h2>
        <p id="noteHabitName" style="font-weight:bold;"></p>
        <textarea
          id="noteText"
          rows="5"
          placeholder="–û–ø–∏—à–∏ —Å–≤–æ—ó –¥—É–º–∫–∏, –ø—Ä–æ–≥—Ä–µ—Å –∞–±–æ –Ω–∞—Å—Ç—Ä—ñ–π..."
        ></textarea>
        <div class="modal-buttons">
          <button class="btn btn-fill" id="saveNoteBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <button class="btn btn-outline" id="cancelNoteBtn">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
    </div>

    <footer class="footer glass">
      <p>¬© 2025 HabitTrack. –£—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.</p>
    </footer>

    <script src="./js/auth.js"></script>
    <script>
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ –≤—Ö–æ–¥—É
      if (!authService.isAuthenticated()) {
        window.location.href = 'login.html';
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
      let currentUser = null;
      let habits = [];
      const API_BASE = authService.apiBaseUrl;

      document.addEventListener("DOMContentLoaded", async () => {
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        currentUser = authService.getCurrentUser();
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–≤–∏—á–∫–∏
        await loadHabits();
        
        // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ evento —Å–ª—É—Ö–∞—á—ñ–≤
        setupEventListeners();
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∑–≤–∏—á–∫–∏
        renderHabits();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—é
        updateAuthButtons();
      });

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤–∏—á–æ–∫ –∑ API
      async function loadHabits() {
        try {
          const response = await fetch(`${API_BASE}/habit/user/${currentUser.userId}`);
          if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤–∏—á–æ–∫');
          habits = await response.json();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤–∏—á–æ–∫');
          habits = [];
        }
      }

      // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è event —Å–ª—É—Ö–∞—á—ñ–≤
      function setupEventListeners() {
        const habitsList = document.getElementById("habitsList");
        const modal = document.getElementById("habitModal");
        const form = document.getElementById("habitForm");
        const addHabitBtn = document.getElementById("addHabitBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const categoryFilter = document.getElementById("habitCategory");
        const isComplexCheckbox = document.getElementById("isComplex");
        const complexSettings = document.getElementById("complexSettings");

        addHabitBtn.addEventListener("click", () => {
          form.reset();
          document.getElementById("habitId").value = "";
          document.getElementById("modalTitle").textContent = "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤–∏—á–∫—É";
          complexSettings.style.display = "none";
          modal.style.display = "flex";
        });

        cancelBtn.addEventListener("click", () => {
          modal.style.display = "none";
        });

        form.addEventListener("submit", handleFormSubmit);
        categoryFilter.addEventListener("change", renderHabits);

        // –ü–æ–∫–∞–∑—É—î–º–æ/–ø—Ä–∏—Ö–æ–≤—É—î–º–æ —Å–∫–ª–∞–¥–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        isComplexCheckbox.addEventListener("change", () => {
          complexSettings.style.display = isComplexCheckbox.checked ? "block" : "none";
        });

        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—é –ø—Ä–∏ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });
      }

      // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏
      async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const habitId = document.getElementById("habitId").value;
        const name = document.getElementById("habitName").value;
        const category = document.getElementById("habitType").value;
        const note = document.getElementById("habitNote")?.value || "";
        const isComplex = document.getElementById("isComplex").checked;
        const repeatCount = isComplex ? parseInt(document.getElementById("repeatCount").value) : 1;

        if (!name.trim()) {
          showError("–ù–∞–∑–≤–∞ –∑–≤–∏—á–∫–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤–∞");
          return;
        }

        try {
          if (habitId) {
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–≤–∏—á–∫–∏
            const response = await fetch(`${API_BASE}/habit/${habitId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: currentUser.userId,
                name: name.trim(),
                category: category,
                note: note,
                repeatCount: repeatCount
              })
            });

            if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–≤–∏—á–∫–∏');
            showSuccess('–ó–≤–∏—á–∫—É –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
          } else {
            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–≤–∏—á–∫–∏
            const response = await fetch(`${API_BASE}/habit`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId: currentUser.userId,
                name: name.trim(),
                category: category,
                note: note,
                repeatCount: repeatCount
              })
            });

            if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤–∏—á–∫–∏');
            showSuccess('–ó–≤–∏—á–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
          }

          // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–≤–∏—á–∫–∏
          await loadHabits();
          renderHabits();
          document.getElementById("habitModal").style.display = "none";
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError(error.message);
        }
      }

      // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–≤–∏—á–∫–∏
      window.editHabit = (habitId) => {
        const habit = habits.find(h => h.habitId === habitId);
        if (!habit) return;

        document.getElementById("habitId").value = habit.habitId;
        document.getElementById("habitName").value = habit.name;
        document.getElementById("habitType").value = habit.category;
        document.getElementById("habitNote").value = habit.note || "";
        document.getElementById("isComplex").checked = habit.repeatCount > 1;
        document.getElementById("repeatCount").value = habit.repeatCount || 1;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ/–ø—Ä–∏—Ö–æ–≤—É—î–º–æ complexSettings
        const complexSettings = document.getElementById("complexSettings");
        complexSettings.style.display = habit.repeatCount > 1 ? "block" : "none";
        
        document.getElementById("modalTitle").textContent = "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–≤–∏—á–∫—É";
        document.getElementById("habitModal").style.display = "flex";
      };

      // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–≤–∏—á–∫–∏
      window.deleteHabit = async (habitId) => {
        if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–≤–∏—á–∫—É?")) return;

        try {
          const response = await fetch(`${API_BASE}/habit/${habitId}?userId=${currentUser.userId}`, {
            method: 'DELETE'
          });

          if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–≤–∏—á–∫–∏');
          
          showSuccess('–ó–≤–∏—á–∫—É –≤–∏–¥–∞–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
          await loadHabits();
          renderHabits();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError(error.message);
        }
      };

      // –ê—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è –∑–≤–∏—á–∫–∏
      window.archiveHabit = async (habitId) => {
        if (!confirm("–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏ —Ü—é –∑–≤–∏—á–∫—É?")) return;

        try {
          const response = await fetch(`${API_BASE}/habit/${habitId}/archive?userId=${currentUser.userId}`, {
            method: 'POST'
          });

          if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è –∑–≤–∏—á–∫–∏');
          
          showSuccess('–ó–≤–∏—á–∫—É –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
          await loadHabits();
          renderHabits();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError(error.message);
        }
      };

      // –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∑–≤–∏—á–∫—É —è–∫ –≤–∏–∫–æ–Ω–∞–Ω—É
      window.markDone = async (habitId) => {
        try {
          const response = await fetch(`${API_BASE}/habit/${habitId}/complete?userId=${currentUser.userId}`, {
            method: 'POST'
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—ñ');
          }

          const data = await response.json();
          showSuccess(`‚úÖ –ó–≤–∏—á–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞! Streak: ${data.streak} –¥–Ω—ñ–≤`);
          await loadHabits();
          renderHabits();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError(error.message);
        }
      };

      // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–≤–∏—á–æ–∫
      function renderHabits() {
        const habitsList = document.getElementById("habitsList");
        const categoryFilter = document.getElementById("habitCategory").value;
        const categoryFilterBlock = document.querySelector(".category-filter");

        if (habits.length === 0) {
          habitsList.innerHTML = "<p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–≤–∏—á–æ–∫. –î–æ–¥–∞–π –ø–µ—Ä—à—É!</p>";
          categoryFilterBlock.style.display = "none";
          return;
        }

        categoryFilterBlock.style.display = "flex";

        const filtered = categoryFilter === "all" 
          ? habits 
          : habits.filter(h => h.category === categoryFilter);

        habitsList.innerHTML = "";

        if (filtered.length === 0) {
          habitsList.innerHTML = "<p>–ù–µ–º–∞—î –∑–≤–∏—á–æ–∫ –≤ —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.</p>";
          return;
        }

        filtered.forEach(habit => {
          const card = document.createElement("div");
          card.className = "habit-card glass";
          const repeatInfo = habit.repeatCount > 1 ? `<p>üîÅ –ü–æ–≤—Ç–æ—Ä–µ–Ω—å: ${habit.repeatCount} —Ä–∞–∑(–∏) –Ω–∞ –¥–µ–Ω—å</p>` : '';
          card.innerHTML = `
            <div class="habit-header">
              <h3>${habit.name}</h3>
              <div class="habit-actions">
                <button title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" onclick="editHabit(${habit.habitId})">‚úèÔ∏è</button>
                <button title="–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏" onclick="archiveHabit(${habit.habitId})">üì¶</button>
                <button title="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="deleteHabit(${habit.habitId})">üóëÔ∏è</button>
              </div>
            </div>
            <p>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${habit.category}</p>
            <p>üî• Streak: <b>${habit.streak}</b> –¥–Ω—ñ–≤</p>
            <p>–í–∏–∫–æ–Ω–∞–Ω–æ: ${habit.completionCount} —Ä–∞–∑(–∏)</p>
            ${repeatInfo}
            ${habit.note ? `<p>üìù –ù–æ—Ç–∞—Ç–∫–∞: ${habit.note}</p>` : ''}
            <button class="btn btn-outline" onclick="markDone(${habit.habitId})">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ —Å—å–æ–≥–æ–¥–Ω—ñ</button>
          `;
          habitsList.appendChild(card);
        });
      }

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
      function updateAuthButtons() {
        const authButtons = document.getElementById("authButtons");
        authButtons.innerHTML = `
          <span class="user-greeting">–ü—Ä–∏–≤—ñ—Ç, ${currentUser.username}!</span>
          <a href="./profile.html" class="btn btn-outline">–ü—Ä–æ—Ñ—ñ–ª—å</a>
          <button onclick="authService.logout()" class="btn btn-fill">–í–∏–π—Ç–∏</button>
        `;
      }

      // –£—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      function showError(message) {
        const errorDiv = document.getElementById("errorMsg");
        if (!errorDiv) return;
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMsg");
        if (!successDiv) return;
        successDiv.textContent = message;
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }
    </script>
  </body>
</html>
