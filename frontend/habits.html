<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HabitTrack ‚Äî –ú–æ—ó –∑–≤–∏—á–∫–∏</title>
    <link rel="stylesheet" href="./style/main.css" />
    <link rel="stylesheet" href="./style/habits.css" />
    <style>
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.8);
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff88;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00cc66;
    }
  </style>
  </head>

  <body>
    <header class="navbar glass">
      <div class="logo">HabitTrack</div>
      <nav class="nav-links">
        <a href="./main.html">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="./habits.html" class="active">–ó–≤–∏—á–∫–∏</a>
        <a href="./stats.html">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        <a href="./archive.html">–ê—Ä—Ö—ñ–≤</a>
      </nav>
      <div class="auth-buttons" id="authButtons"></div>
    </header>

    <main class="section glass habits-section">
      <h1>–ú–æ—ó –∑–≤–∏—á–∫–∏</h1>
      <p class="subtitle">
        –ö–µ—Ä—É–π—Ç–µ —Å–≤–æ—ó–º–∏ –∑–≤–∏—á–∫–∞–º–∏, –≤—ñ–¥—Å—Ç–µ–∂—É–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å —ñ —Å—Ç–≤–æ—Ä—é–π—Ç–µ –Ω–æ–≤—ñ —Ü—ñ–ª—ñ –¥–ª—è
        —Å–∞–º–æ—Ä–æ–∑–≤–∏—Ç–∫—É.
      </p>

      <button class="btn btn-fill" id="addHabitBtn">‚ûï –î–æ–¥–∞—Ç–∏ –∑–≤–∏—á–∫—É</button>

      <div class="category-filter" style="display: none">
        <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
        <select id="habitCategory">
          <option value="all">–£—Å—ñ</option>
          <option value="—Å–æ–Ω">–°–æ–Ω</option>
          <option value="—Å–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
          <option value="—Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è</option>
          <option value="—ñ–Ω—à–µ">–Ü–Ω—à–µ</option>
        </select>
      </div>

      <div class="habits-grid" id="habitsList"></div>
    </main>

    <div class="modal" id="habitModal">
      <div class="modal-content glass">
        <h2 id="modalTitle">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤–∏—á–∫—É</h2>
        <form id="habitForm">
          <input type="hidden" id="habitId" />

          <label>–ù–∞–∑–≤–∞ –∑–≤–∏—á–∫–∏:</label>
          <input
            type="text"
            id="habitName"
            required
            placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –†–∞–Ω–∫–æ–≤–∞ –∑–∞—Ä—è–¥–∫–∞"
          />

          <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
          <select id="habitType" required>
            <option value="—Å–æ–Ω">–°–æ–Ω</option>
            <option value="—Å–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
            <option value="—Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è">–•–∞—Ä—á—É–≤–∞–Ω–Ω—è</option>
            <option value="—ñ–Ω—à–µ">–Ü–Ω—à–µ</option>
          </select>

          <label>–¶—ñ–ª—å (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤):</label>
          <input type="number" id="habitGoal" min="1" max="30" value="7" />

          <label class="complex-label">
            <input type="checkbox" id="isComplex" /> –°–∫–ª–∞–¥–Ω–∞ –∑–≤–∏—á–∫–∞ (–∫—ñ–ª—å–∫–∞
            —Ä–∞–∑—ñ–≤ –Ω–∞ –¥–µ–Ω—å)
          </label>

          <div id="complexSettings" style="display: none">
            <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω—å –Ω–∞ –¥–µ–Ω—å:</label>
            <input type="number" id="timesPerDay" min="1" max="10" value="1" />
          </div>

          <div class="modal-buttons">
            <button type="submit" class="btn btn-fill">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button type="button" class="btn btn-outline" id="cancelBtn">
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="noteModal">
      <div class="modal-content glass">
        <h2>–ù–æ—Ç–∞—Ç–∫–∞ –¥–æ –∑–≤–∏—á–∫–∏</h2>
        <p id="noteHabitName" style="font-weight:bold;"></p>
        <textarea
          id="noteText"
          rows="5"
          placeholder="–û–ø–∏—à–∏ —Å–≤–æ—ó –¥—É–º–∫–∏, –ø—Ä–æ–≥—Ä–µ—Å –∞–±–æ –Ω–∞—Å—Ç—Ä—ñ–π..."
        ></textarea>
        <div class="modal-buttons">
          <button class="btn btn-fill" id="saveNoteBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
          <button class="btn btn-outline" id="cancelNoteBtn">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
    </div>

    <footer class="footer glass">
      <p>¬© 2025 HabitTrack. –£—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.</p>
    </footer>

    <script src="./js/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const habitsList = document.getElementById("habitsList");
        const modal = document.getElementById("habitModal");
        const form = document.getElementById("habitForm");
        const addHabitBtn = document.getElementById("addHabitBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const categoryFilter = document.getElementById("habitCategory");
        const categoryFilterBlock = document.querySelector(".category-filter");
        const complexCheckbox = document.getElementById("isComplex");
        const complexSettings = document.getElementById("complexSettings");

        let habits = JSON.parse(localStorage.getItem("habits")) || [];
        const saveHabits = () =>
          localStorage.setItem("habits", JSON.stringify(habits));

        const startOfDay = (d) =>
          new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const today = startOfDay(new Date());

        const daysBetween = (a, b) => {
          const A = startOfDay(a).getTime();
          const B = startOfDay(b).getTime();
          return Math.round((A - B) / (1000 * 60 * 60 * 24));
        };

        const normalizeHabits = () => {
          let changed = false;
          const today = startOfDay(new Date());
          habits.forEach((h) => {
            if (h.progress == null) h.progress = 0;
            if (h.streak == null) h.streak = 0;
            if (h.doneToday == null) h.doneToday = 0;
            if (h.completedToday == null) h.completedToday = false;
            if (!h.lastCompleted) h.lastCompleted = null;
            if (!h.lastUpdated) h.lastUpdated = today.toISOString();

            if (!h.notes) h.notes = {};


                        const lastUpd = startOfDay(new Date(h.lastUpdated));
                        const lastDone = h.lastCompleted ? startOfDay(new Date(h.lastCompleted)) : null;
                        // –Ø–∫—â–æ –¥–µ–Ω—å –∑–º—ñ–Ω–∏–≤—Å—è
                        if (lastUpd.getTime() !== today.getTime()) {
                          h.doneToday = 0;
                          h.progress = 0;
                          h.completedToday = false;
                          h.lastUpdated = today.toISOString();
                          // —è–∫—â–æ –∑–≤–∏—á–∫—É –Ω–µ –≤–∏–∫–æ–Ω–∞–ª–∏ –≤—á–æ—Ä–∞ ‚Äî –æ–±–Ω—É–ª—è—î–º–æ streak
                          if (lastDone && (today - lastDone) / (1000 * 60 * 60 * 24) > 1) {
                            h.streak = 0;
                          }
                          changed = true;
                        }
                      });
                      if (changed) saveHabits();
                    };


        normalizeHabits();

        complexCheckbox.addEventListener("change", () => {
          complexSettings.style.display = complexCheckbox.checked
            ? "block"
            : "none";
        });

        const renderHabits = () => {
          habitsList.innerHTML = "";
          const filter = categoryFilter.value;
          const filtered =
            filter === "all"
              ? habits.filter((h) => !h.archived)
              : habits.filter((h) => h.type === filter && !h.archived);

          if (habits && habits.length > 0 && habits.some((h) => !h.archived)) {
            categoryFilterBlock.style.display = "flex";
            requestAnimationFrame(() =>
              categoryFilterBlock.classList.add("visible")
            );
          } else {
            categoryFilterBlock.classList.remove("visible");
            setTimeout(() => {
              categoryFilterBlock.style.display = "none";
            }, 400);
          }

          if (filtered.length === 0) {
            habitsList.innerHTML = "<p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–≤–∏—á–æ–∫. –î–æ–¥–∞–π –ø–µ—Ä—à—É!</p>";
            return;
          }

          filtered.forEach((habit) => {
            const card = document.createElement("div");
            card.className = "habit-card glass";
            card.innerHTML = `
        <div class="habit-header">
          <h3>${habit.name}</h3>
          <div class="habit-actions">
            <button title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" onclick="editHabit('${
              habit.id
            }')">‚úèÔ∏è</button>
            <button title="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="deleteHabit('${
              habit.id
            }')">üóëÔ∏è</button>
            <button title="–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏" onclick="archiveHabit('${
              habit.id
            }')">üì¶</button>
          </div>
        </div>
        <p>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${habit.type}</p>
        <p>–¶—ñ–ª—å: ${habit.goal} —Ä–∞–∑—ñ–≤/—Ç–∏–∂–¥–µ–Ω—å</p>
        ${
          habit.complex
            ? `<p>–°–∫–ª–∞–¥–Ω–∞ –∑–≤–∏—á–∫–∞: ${habit.timesPerDay} —Ä–∞–∑(–∏) –Ω–∞ –¥–µ–Ω—å</p>`
            : ""
        }
        <p>üî• –ü–æ—Ç–æ—á–Ω–∏–π Streak: <b>${habit.streak || 0}</b> –¥–Ω—ñ–≤</p>
        ${
          habit.complex
            ? `<p class="progress-info">–í–∏–∫–æ–Ω–∞–Ω–æ —Å—å–æ–≥–æ–¥–Ω—ñ: ${
                habit.doneToday || 0
              }/${habit.timesPerDay}</p>`
            : ""
        }
            <button class="btn btn-outline" onclick="openNote('${habit.id}')">üìù –ù–æ—Ç–∞—Ç–∫–∞</button>
        <button class="btn btn-outline" onclick="markDone('${
          habit.id
        }')">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ —Å—å–æ–≥–æ–¥–Ω—ñ</button>
        <div class="progress-bar">
          <div class="progress-bar-fill" style="width: ${Math.min(
            100,
            Math.max(0, habit.progress || 0)
          )}%;"></div>
        </div>
      `;
            habitsList.appendChild(card);
          });
        };

        addHabitBtn.addEventListener("click", () => {
          form.reset();
          document.getElementById("habitId").value = "";
          document.getElementById("modalTitle").textContent = "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤–∏—á–∫—É";
          modal.style.display = "flex";
          complexSettings.style.display = "none";
        });

        cancelBtn.addEventListener(
          "click",
          () => (modal.style.display = "none")
        );

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const id =
            document.getElementById("habitId").value || Date.now().toString();
          const newHabit = {
            id,
            name: document.getElementById("habitName").value,
            type: document.getElementById("habitType").value,
            goal: parseInt(document.getElementById("habitGoal").value),
            complex: document.getElementById("isComplex").checked,
            timesPerDay:
              parseInt(document.getElementById("timesPerDay").value) || 1,
            doneToday: 0,
            progress: 0,
            completedToday: false,
            streak: 0,
            lastCompleted: null,
            lastUpdated: today.toISOString(),
            archived: false,
            notes: {}
          };

          const idx = habits.findIndex((h) => h.id === id);
          if (idx >= 0) {
            newHabit.streak = habits[idx].streak || 0;
            newHabit.lastCompleted = habits[idx].lastCompleted || null;
            newHabit.completedToday = habits[idx].completedToday || false;
            newHabit.doneToday = habits[idx].doneToday || 0;
            newHabit.progress = habits[idx].progress || 0;
            newHabit.lastUpdated =
              habits[idx].lastUpdated || today.toISOString();
              newHabit.notes = habits[idx].notes || {};
            habits[idx] = newHabit;
          } else {
            habits.push(newHabit);
          }

          saveHabits();
          renderHabits();
          modal.style.display = "none";
        });

        categoryFilter.addEventListener("change", renderHabits);

        window.editHabit = (id) => {
          const h = habits.find((h) => h.id === id);
          if (!h) return;
          document.getElementById("habitId").value = h.id;
          document.getElementById("habitName").value = h.name;
          document.getElementById("habitType").value = h.type;
          document.getElementById("habitGoal").value = h.goal;
          document.getElementById("isComplex").checked = h.complex;
          document.getElementById("timesPerDay").value = h.timesPerDay || 1;
          complexSettings.style.display = h.complex ? "block" : "none";
          document.getElementById("modalTitle").textContent =
            "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–≤–∏—á–∫—É";
          modal.style.display = "flex";
        };

        window.deleteHabit = (id) => {
          if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–≤–∏—á–∫—É?")) {
            habits = habits.filter((h) => h.id !== id);
            saveHabits();
            renderHabits();
          }
        };

        window.markDone = (id) => {
          const h = habits.find((h) => h.id === id);
          if (!h) return;

          const now = new Date();
          const today = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate()
          );

          if (h.completedToday) {
            alert("–¶—è –∑–≤–∏—á–∫–∞ –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ!");
            return;
          }

          if (h.complex) {
            h.doneToday = (h.doneToday || 0) + 1;
            if (h.doneToday > h.timesPerDay) h.doneToday = h.timesPerDay;
            h.progress = Math.round((h.doneToday / h.timesPerDay) * 100);
          } else {
            h.progress = 100;
          }

          if (h.progress >= 100) {
            if (h.lastCompleted) {
              const last = new Date(h.lastCompleted);
              const lastDay = new Date(
                last.getFullYear(),
                last.getMonth(),
                last.getDate()
              );
              const diffDays = Math.floor(
                (today - lastDay) / (1000 * 60 * 60 * 24)
              );

              if (diffDays === 1) {
                h.streak = (h.streak || 0) + 1;
              } else if (diffDays >= 2) {
                h.streak = 1;
              } else if (diffDays === 0) {
                h.streak = h.streak || 1;
              }
            } else {
              h.streak = 1;
            }

            h.completedToday = true;
            h.lastCompleted = today.toISOString();
          }

          h.lastUpdated = today.toISOString();
          saveHabits();
          renderHabits();
        };

        window.archiveHabit = (id) => {
          const h = habits.find((h) => h.id === id);
          if (h) {
            h.archived = true;
            saveHabits();
            renderHabits();
          }
        };

        const noteModal = document.getElementById("noteModal");
        const noteText = document.getElementById("noteText");
        const noteHabitName = document.getElementById("noteHabitName");
        const saveNoteBtn = document.getElementById("saveNoteBtn");
        const cancelNoteBtn = document.getElementById("cancelNoteBtn");
        let currentHabitId = null;

        window.openNote = (id) => {
          const h = habits.find((x) => x.id === id);
          if (!h) return;

          currentHabitId = id;
          const todayKey = new Date().toISOString().split("T")[0];
          noteHabitName.textContent = h.name + " ‚Äî " + todayKey;
          noteText.value = h.notes?.[todayKey] || "";
          noteModal.style.display = "flex";
        };

        saveNoteBtn.addEventListener("click", () => {
          if (!currentHabitId) return;
          const h = habits.find((x) => x.id === currentHabitId);
          if (!h) return;

          const todayKey = new Date().toISOString().split("T")[0];
          h.notes = h.notes || {};
          h.notes[todayKey] = noteText.value;

          saveHabits();
          noteModal.style.display = "none";
          alert("‚úÖ –ù–æ—Ç–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
        });

        cancelNoteBtn.addEventListener(
          "click",
          () => (noteModal.style.display = "none")
        );

        renderHabits();
      });

      

      document.addEventListener("DOMContentLoaded", () => {
        const authButtons = document.getElementById("authButtons");
        if (authService.isAuthenticated()) {
          const user = authService.getCurrentUser();
          authButtons.innerHTML = `
      <span class="user-greeting">–ü—Ä–∏–≤—ñ—Ç, ${user.username}!</span>
      <a href="./profile.html" class="btn btn-outline">–ü—Ä–æ—Ñ—ñ–ª—å</a>
      <button onclick="authService.logout()" class="btn btn-fill">–í–∏–π—Ç–∏</button>
    `;
        } else {
          authButtons.innerHTML = `
      <a href="./login.html" class="btn btn-outline">–£–≤—ñ–π—Ç–∏</a>
      <a href="./register.html" class="btn btn-fill">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
    `;
        }
      });
    </script>
  </body>
</html>
