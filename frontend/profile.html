<!-- /HabitTrack/profile.html -->
<!DOCTYPE html>
<html lang="uk">
<head>
    <style>
  #particles-js{position:fixed;inset:0;z-index:0;pointer-events:none}
  .navbar,.profile-wrap{position:relative;z-index:2}
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HabitTrack — Профіль</title>
  <link rel="stylesheet" href="./style/main.css" />
  <link rel="stylesheet" href="./style/profile.css" />
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="./js/auth.js"></script>
</head>
<body>

<header class="navbar glass">
  <div class="logo">HabitTrack</div>
  <nav class="nav-links">
  <a href="./main.html">Головна</a>
    <a href="#about">Про нас</a>
    <a href="#features">Функції</a>
    <a href="#contact">Контакти</a>
  </nav>
  <div class="auth-buttons" id="authButtons">
    <!-- Буде заповнено JavaScript -->
  </div>
</header>


  <main class="profile-wrap">
    <section class="profile-card glass">
      <aside class="profile-side">
        <div class="avatar-wrap">
          <img id="avatarPreview" src="https://api.dicebear.com/7.x/identicon/svg?seed=HabitUser" alt="Аватар користувача" />
          <div id="avatarActions">
            <button class="btn-outline" id="editProfileBtn">Редагувати профіль</button>
            <label class="btn-outline file-label" id="uploadAvatarBtn" style="display: none;">
              Завантажити аватар
              <input id="avatarInput" type="file" accept="image/*" hidden />
            </label>
          </div>
        </div>

        <div class="profile-meta">
          <div class="meta-item">
            <span class="meta-k">12</span>
            <span class="meta-l">звичок</span>
          </div>
          <div class="meta-item">
            <span class="meta-k">86%</span>
            <span class="meta-l">стрик</span>
          </div>
          <div class="meta-item">
            <span class="meta-k">214</span>
            <span class="meta-l">днів разом</span>
          </div>
        </div>

        <div class="profile-badges">
          <span class="badge">#раннійптах</span>
          <span class="badge">#фітнес</span>
          <span class="badge">#фокус</span>
        </div>
      </aside>

      <!-- Звичайний профіль (тільки перегляд) -->
      <div class="profile-view" id="profileView">
        <div class="profile-info">
          <h2 id="viewUsername">Username</h2>
          <p id="viewEmail">email@example.com</p>
          <p class="join-date">Приєднався: <span id="viewJoinDate">1 січня 2024</span></p>
        </div>
      </div>

      <!-- Форма редагування профілю -->
      <form class="profile-form" id="profileForm" action="#" method="post" style="display: none;">
        <div class="form-grid">
          <div class="form-group">
            <label for="fullName">Ім'я та прізвище</label>
            <input class="control" type="text" id="fullName" name="fullName" placeholder="Ім'я Прізвище" required>
          </div>

          <div class="form-group">
            <label for="username">Нікнейм</label>
            <div class="prefixed">
              <span>@</span>
              <input class="control" type="text" id="username" name="username" placeholder="username" required>
            </div>
          </div>

          <div class="form-group">
            <label for="email">Ел. пошта</label>
            <input class="control" type="email" id="email" name="email" placeholder="you@example.com" required>
          </div>


          <details class="form-span-2 pw-toggle">
            <summary>Змінити пароль</summary>
            <div class="pw-grid">
              <div class="form-group">
                <label for="currentPassword">Поточний пароль</label>
                <input class="control" type="password" id="currentPassword" name="currentPassword" autocomplete="current-password">
              </div>
              <div class="form-group">
                <label for="newPassword">Новий пароль</label>
                <input class="control" type="password" id="newPassword" name="newPassword" autocomplete="new-password">
              </div>
              <div class="form-group">
                <label for="confirmPassword">Підтвердьте пароль</label>
                <input class="control" type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password">
              </div>
            </div>
          </details>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-outline" id="cancelBtn">Скасувати</button>
          <button type="submit" class="btn-primary">Зберегти зміни</button>
        </div>
      </form>
    </section>
  </main>

  <div id="particles-js"></div>

  <script>
    let currentUser = null;

    // Ініціалізація particles.js
    particlesJS("particles-js", {
      "particles": {
        "number": {"value": 45},
        "color": {"value": "#00ff88"},
        "shape": {"type": "circle"},
        "opacity": {"value": 0.35},
        "size": {"value": 2, "random": true},
        "line_linked": {"enable": true, "distance": 140, "color": "#00ff88", "opacity": 0.25, "width": 1},
        "move": {"enable": true, "speed": 1.6}
      },
      "interactivity": {
        "events": {"onhover": {"enable": true, "mode": "repulse"}},
        "modes": {"repulse": {"distance": 120}}
      }
    });

    // Перевірка авторизації при завантаженні сторінки
    document.addEventListener('DOMContentLoaded', async () => {
      if (!authService.checkPageAuth()) return;

      currentUser = authService.getCurrentUser();
      
      // Оновлюємо навігацію
      const authButtons = document.getElementById('authButtons');
      authButtons.innerHTML = `
        <span class="user-greeting">Привіт, ${currentUser.username}!</span>
        <a href="main.html" class="btn btn-outline">Головна</a>
        <button onclick="authService.logout()" class="btn btn-fill">Вийти</button>
      `;

      // Завантажуємо дані користувача
      await loadUserData();
    });

    // Завантаження даних користувача
    async function loadUserData() {
      try {
        const userData = await authService.getUserData(currentUser.userId);
        
        // Оновлюємо звичайний профіль
        document.getElementById('viewUsername').textContent = userData.username || '';
        document.getElementById('viewEmail').textContent = userData.email || '';
        
        // Форматуємо дату приєднання
        const joinDate = new Date(userData.createdAt);
        const formattedDate = joinDate.toLocaleDateString('uk-UA', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        document.getElementById('viewJoinDate').textContent = formattedDate;
        
        // Заповнюємо форму редагування
        document.getElementById('fullName').value = userData.username || '';
        document.getElementById('username').value = userData.username || '';
        document.getElementById('email').value = userData.email || '';
        
        // Оновлюємо аватар (будуємо абсолютний URL до бекенду, якщо потрібно)
        if (userData.avatarUrl) {
          let avatarUrl = userData.avatarUrl;
          try {
            // Якщо від бекенду прийшов відносний шлях (наприклад "/api/user/..."),
            // додаємо базовий URL до API (http://localhost:5000)
            if (avatarUrl.startsWith('/')) {
              const apiBase = authService.apiBaseUrl.replace(/\/api\/?$/, '');
              avatarUrl = apiBase + avatarUrl;
            }
          } catch (e) {
            console.error('Error building avatar URL', e);
          }
          document.getElementById('avatarPreview').src = avatarUrl;
        }

      } catch (error) {
        console.error('Помилка завантаження даних:', error);
        authService.showError('Помилка завантаження профілю');
      }
    }

    // Обробка завантаження аватара
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    avatarInput?.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      avatarPreview.src = url;
    });

    // Функції для перемикання між режимами
    function showEditMode() {
      document.getElementById('profileView').style.display = 'none';
      document.getElementById('profileForm').style.display = 'block';
      document.getElementById('editProfileBtn').style.display = 'none';
      document.getElementById('uploadAvatarBtn').style.display = 'block';
    }

    function showViewMode() {
      document.getElementById('profileView').style.display = 'block';
      document.getElementById('profileForm').style.display = 'none';
      document.getElementById('editProfileBtn').style.display = 'block';
      document.getElementById('uploadAvatarBtn').style.display = 'none';
    }

    // Обробка кнопки редагування профілю
    document.getElementById('editProfileBtn').addEventListener('click', showEditMode);

    // Обробка відправки форми
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        username: document.getElementById('fullName').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      // Якщо користувач вибрав новий файл у input, завантажуємо його окремим запитом
      const fileInput = document.getElementById('avatarInput');
      if (fileInput && fileInput.files && fileInput.files.length > 0) {
        try {
          await authService.uploadAvatar(currentUser.userId, fileInput.files[0]);
        } catch (err) {
          authService.showError('Не вдалося завантажити аватар');
          return;
        }
      }

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      try {
        // Оновлюємо профіль
        await authService.updateProfile(currentUser.userId, formData);
        
        // Якщо змінюється пароль
        if (newPassword || confirmPassword) {
          if (newPassword.length < 8) {
            authService.showError('Новий пароль має містити щонайменше 8 символів');
            return;
          }
          if (newPassword !== confirmPassword) {
            authService.showError('Паролі не співпадають');
            return;
          }
          if (!currentPassword) {
            authService.showError('Введіть поточний пароль');
            return;
          }
          
          await authService.changePassword(currentUser.userId, currentPassword, newPassword);
        }

        authService.showSuccess('✅ Зміни збережено успішно!');
        
        // Очищуємо поля паролів
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Повертаємося до режиму перегляду та оновлюємо дані
        await loadUserData();
        showViewMode();

      } catch (error) {
        authService.showError(error.message);
      }
    });

    // Обробка кнопки скасування
    document.getElementById('cancelBtn').addEventListener('click', () => {
      showViewMode();
    });
  </script>

</body>
</html>
