<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HabitTrack ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
  <link rel="stylesheet" href="./style/main.css" />
  <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              neon: "#00ff88",
              dark: "#0b0b0b",
            },
            fontFamily: {
              treb: ['"Trebuchet MS"', '"Segoe UI"', "Arial", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.8);
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff88;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00cc66;
    }
  </style>
  </head>

  <body
    class="bg-[radial-gradient(ellipse_at_top,_#0b0b0b_40%,_#050505_100%)] text-[#e0e0e0] font-treb overflow-x-hidden"
  >
    <!-- Shared header (uses auth.js to render auth buttons) -->
    <header class="navbar glass">
      <div class="logo">HabitTrack</div>
      <nav class="nav-links">
        <a href="./main.html">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="./habits.html">–ó–≤–∏—á–∫–∏</a>
        <a href="./stats.html" class="active">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        <a href="./archive.html">–ê—Ä—Ö—ñ–≤</a>
      </nav>
      <div class="auth-buttons" id="authButtons">
        <!-- Filled by auth.js on DOMContentLoaded -->
      </div>
    </header>

    <main class="pt-44 pb-24 text-center px-6 max-w-6xl mx-auto">
      <h1
        class="text-4xl font-bold text-[#00ff88] drop-shadow-[0_0_12px_rgba(0,255,120,0.6)] mb-4"
      >
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–∏—á–æ–∫
      </h1>
      <p class="text-gray-300 text-lg mb-12">
        –ü–µ—Ä–µ–≥–ª—è–¥–∞–π —Å–≤—ñ–π –ø—Ä–æ–≥—Ä–µ—Å, –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª –∑–≤–∏—á–æ–∫ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏.
      </p>

      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
        <div
          class="p-8 bg-[rgba(20,20,20,0.8)] border border-[rgba(0,255,120,0.3)] rounded-2xl shadow-lg hover:scale-105 transition"
        >
          <h3 class="text-[#00ff88] text-lg font-semibold mb-2">
            üìÖ –ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–≤–∏—á–æ–∫
          </h3>
          <p id="totalHabits" class="text-4xl font-bold text-white">0</p>
        </div>
        <div
          class="p-8 bg-[rgba(20,20,20,0.8)] border border-[rgba(0,255,120,0.3)] rounded-2xl shadow-lg hover:scale-105 transition"
        >
          <h3 class="text-[#00ff88] text-lg font-semibold mb-2">
            ‚úÖ –°–µ—Ä–µ–¥–Ω—ñ–π –ø—Ä–æ–≥—Ä–µ—Å
          </h3>
          <p id="avgProgress" class="text-4xl font-bold text-white">0%</p>
        </div>
        <div
          class="p-8 bg-[rgba(20,20,20,0.8)] border border-[rgba(0,255,120,0.3)] rounded-2xl shadow-lg hover:scale-105 transition"
        >
          <h3 class="text-[#00ff88] text-lg font-semibold mb-2">
            üî• –°–µ—Ä–µ–¥–Ω—ñ–π Streak
          </h3>
          <p id="avgStreak" class="text-4xl font-bold text-white">0 –¥–Ω—ñ–≤</p>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-12">
        <div
          class="bg-[rgba(20,20,20,0.8)] border border-[rgba(0,255,120,0.3)] rounded-3xl p-10 shadow-lg"
        >
          <h2 class="text-[#00ff88] text-2xl font-semibold mb-6">
            –ì—Ä–∞—Ñ—ñ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–≤–∏—á–æ–∫
          </h2>
          <canvas id="progressChart" height="100"></canvas>
        </div>

        <div
          class="bg-[rgba(20,20,20,0.8)] border border-[rgba(0,255,120,0.3)] rounded-3xl p-10 shadow-lg"
        >
          <h2 class="text-[#00ff88] text-2xl font-semibold mb-6">
            –†–æ–∑–ø–æ–¥—ñ–ª –∑–≤–∏—á–æ–∫ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏
          </h2>
          <canvas id="categoryChart" height="100"></canvas>
        </div>
      </div>
    </main>

    <footer
      class="border-t border-[rgba(0,255,120,0.15)] py-6 text-center text-gray-400 text-sm"
    >
      ¬© 2025 HabitTrack. –£—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.
    </footer>

    <script src="./js/auth.js"></script>
    <script>
      // Update header auth buttons and load habits for statistics.
      document.addEventListener('DOMContentLoaded', async () => {
        // Render auth buttons like other pages
        const authButtons = document.getElementById('authButtons');
        if (authService.isAuthenticated()) {
          const user = authService.getCurrentUser();
          authButtons.innerHTML = `
            <span class="user-greeting">–ü—Ä–∏–≤—ñ—Ç, ${user.username}!</span>
            <a href="./profile.html" class="btn btn-outline">–ü—Ä–æ—Ñ—ñ–ª—å</a>
            <button onclick="authService.logout()" class="btn btn-fill">–í–∏–π—Ç–∏</button>
          `;
        } else {
          authButtons.innerHTML = `
            <a href="./login.html" class="btn btn-outline">–£–≤—ñ–π—Ç–∏</a>
            <a href="./register.html" class="btn btn-fill">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
          `;
        }

        // Load habits: prefer API when authenticated, fallback to localStorage
        let habits = [];
        if (authService.isAuthenticated()) {
          try {
            const user = authService.getCurrentUser();
            const token = user.token;
            const res = await fetch(`${authService.apiBaseUrl}/habit/user/${user.userId}`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (res.ok) {
              habits = await res.json();
            } else {
              // fallback to localStorage if API fails
              habits = JSON.parse(localStorage.getItem('habits')) || [];
            }
          } catch (e) {
            console.error('Failed to load habits from API, fallback to localStorage', e);
            habits = JSON.parse(localStorage.getItem('habits')) || [];
          }
        } else {
          habits = JSON.parse(localStorage.getItem('habits')) || [];
        }

        const activeHabits = (habits || []).filter((h) => !h.archived);
        const totalHabits = activeHabits.length;

        const perHabitPercents = activeHabits.map((h) => {
          const completions = Number(h.completionCount || 0);
          const denom = Number(h.goal || h.duration || 100);
          if (!denom || denom <= 0) return 0;
          const p = Math.round((completions / denom) * 100);
          return Math.min(p, 100);
        });

        const avgProgress = totalHabits
          ? Math.round(perHabitPercents.reduce((s, v) => s + v, 0) / totalHabits)
          : 0;

        const avgStreak = totalHabits
          ? Math.round(
              activeHabits.reduce((sum, h) => sum + (h.streak || 0), 0) /
                totalHabits
            )
          : 0;

        document.getElementById('totalHabits').textContent = totalHabits;
        document.getElementById('avgProgress').textContent = avgProgress + '%';
        document.getElementById('avgStreak').textContent = avgStreak + ' –¥–Ω—ñ–≤';

  const labels = activeHabits.map((h) => h.name);
  // Use per-habit percent values for charting
  const progressData = activeHabits.map((h, idx) => perHabitPercents[idx] || 0);

        const drawChart = (ctx, labels, data) => {
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                {
                  label: '–ü—Ä–æ–≥—Ä–µ—Å (%)',
                  data,
                  backgroundColor: 'rgba(0, 255, 136, 0.4)',
                  borderColor: '#00ff88',
                  borderWidth: 1.5,
                  borderRadius: 6,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, max: 100, ticks: { color: '#00ff88' }, grid: { color: 'rgba(0,255,136,0.15)' } },
                x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(0,255,136,0.1)' } },
              },
              plugins: { legend: { display: false } },
            },
          });
        };

        const container = document.getElementById('progressChart').parentElement;
        container.innerHTML = '';

        if (labels.length <= 5) {
          const canvas = document.createElement('canvas');
          container.appendChild(canvas);
          drawChart(canvas, labels, progressData);
        } else {
          const chunkSize = 5;
          for (let i = 0; i < labels.length; i += chunkSize) {
            const chunkLabels = labels.slice(i, i + chunkSize);
            const chunkData = progressData.slice(i, i + chunkSize);
            const canvas = document.createElement('canvas');
            canvas.height = 120;
            canvas.classList.add('my-6');
            container.appendChild(canvas);
            drawChart(canvas, chunkLabels, chunkData);
          }
        }

        const categories = {};
        activeHabits.forEach((h) => {
          const category = h.category || h.type || h.habitType || '–Ü–Ω—à–µ';
          categories[category] = (categories[category] || 0) + 1;
        });

        const ctx2 = document.getElementById('categoryChart');
        new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: Object.keys(categories),
            datasets: [
              {
                data: Object.values(categories),
                backgroundColor: [
                  'rgba(204, 153, 255, 0.6)',
                  'rgba(255, 153, 204, 0.6)',
                  'rgba(51, 153, 255, 0.6)',
                  'rgba(255, 99, 132, 0.6)',
                  'rgba(160, 100, 255, 0.6)',
                  'rgba(255, 165, 0, 0.6)',
                ],
                borderColor: '#0a0a0a',
                borderWidth: 2,
              },
            ],
          },
          options: {
            plugins: {
              legend: { labels: { color: '#00ff88', font: { size: 14 } } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed} –∑–≤–∏—á–æ–∫` } },
            },
            cutout: '70%',
          },
        });
      });
    </script>
  </body>
</html>
