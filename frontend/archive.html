<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HabitTrack ‚Äî –ê—Ä—Ö—ñ–≤ –∑–≤–∏—á–æ–∫</title>
    <link rel="stylesheet" href="./style/main.css" />
    <link rel="stylesheet" href="./style/habits.css" />
    <style>
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.8);
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff88;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00cc66;
    }
  </style>
  </head>

  <body>
    <header class="navbar glass">
      <div class="logo">HabitTrack</div>
      <nav class="nav-links">
        <a href="./main.html">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="./habits.html">–ó–≤–∏—á–∫–∏</a>
        <a href="./stats.html">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
        <a href="./archive.html" class="active">–ê—Ä—Ö—ñ–≤</a>
      </nav>
      <div class="auth-buttons" id="authButtons"></div>
    </header>

    <main class="section glass habits-section">
      <h1>üì¶ –ê—Ä—Ö–∏–≤ –∑–≤–∏—á–æ–∫</h1>
      <p class="subtitle">
        –û—Å—å –≤–∞—à—ñ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω—ñ –∑–≤–∏—á–∫–∏. –í–∏ –º–æ–∂–µ—Ç–µ —ó—Ö –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —É –±—É–¥—å-—è–∫–∏–π —á–∞—Å.
      </p>

      <div class="msg error" id="errorMsg" style="display: none;"></div>
      <div class="msg success" id="successMsg" style="display: none;"></div>

      <div class="archive-grid" id="archiveList"></div>
    </main>

    <!-- –ü—ñ–¥–≤–∞–ª -->
        <!-- –ü—ñ–¥–≤–∞–ª -->
    <footer class="footer glass">
      <p>¬© 2025 HabitTrack. –£—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω—ñ.</p>
    </footer>

    <!-- JavaScript -->
    <script src="./js/auth.js"></script>
    <script>
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ –≤—Ö–æ–¥—É
      if (!authService.isAuthenticated()) {
        window.location.href = 'login.html';
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
      let currentUser = null;
      let archivedHabits = [];
      const API_BASE = authService.apiBaseUrl;

      document.addEventListener("DOMContentLoaded", async () => {
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        currentUser = authService.getCurrentUser();
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω—ñ –∑–≤–∏—á–∫–∏
        await loadArchivedHabits();
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∑–≤–∏—á–∫–∏
        renderArchivedHabits();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—é
        updateAuthButtons();
      });

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏—Ö –∑–≤–∏—á–æ–∫ –∑ API
      async function loadArchivedHabits() {
        try {
          const response = await fetch(`${API_BASE}/habit/user/${currentUser.userId}/archived`);
          if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É');
          archivedHabits = await response.json();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É –∑–≤–∏—á–æ–∫');
          archivedHabits = [];
        }
      }

      // –†–æ–∑–∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è –∑–≤–∏—á–∫–∏
      window.unarchiveHabit = async (habitId) => {
        if (!confirm("–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Ü—é –∑–≤–∏—á–∫—É?")) return;

        try {
          const response = await fetch(`${API_BASE}/habit/${habitId}/unarchive?userId=${currentUser.userId}`, {
            method: 'POST'
          });

          if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑–∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—ñ');
          
          showSuccess('–ó–≤–∏—á–∫—É –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
          await loadArchivedHabits();
          renderArchivedHabits();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError(error.message);
        }
      };

      // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–≤–∏—á–∫–∏ –∑ –∞—Ä—Ö—ñ–≤—É
      window.deleteArchivedHabit = async (habitId) => {
        if (!confirm("–ù–∞–∑–∞–≤–∂–¥–∏ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–≤–∏—á–∫—É?")) return;

        try {
          const response = await fetch(`${API_BASE}/habit/${habitId}?userId=${currentUser.userId}`, {
            method: 'DELETE'
          });

          if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
          
          showSuccess('–ó–≤–∏—á–∫—É –≤–∏–¥–∞–ª–µ–Ω–æ');
          await loadArchivedHabits();
          renderArchivedHabits();
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞:', error);
          showError(error.message);
        }
      };

      // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–∏—Ö –∑–≤–∏—á–æ–∫
      function renderArchivedHabits() {
        const habitsList = document.getElementById("archiveList");

        if (archivedHabits.length === 0) {
          habitsList.innerHTML = "<p>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç–∏–π. –í–∏ –ø–æ–∫–∏ –Ω–µ –∞—Ä—Ö—ñ–≤—É–≤–∞–ª–∏ –∂–æ–¥–Ω–æ—ó –∑–≤–∏—á–∫–∏.</p>";
          return;
        }

        habitsList.innerHTML = "";

        archivedHabits.forEach(habit => {
          const card = document.createElement("div");
          card.className = "habit-card glass";
          const repeatInfo = habit.repeatCount > 1 ? `<p>üîÅ –ü–æ–≤—Ç–æ—Ä–µ–Ω—å: ${habit.repeatCount} —Ä–∞–∑(–∏) –Ω–∞ –¥–µ–Ω—å</p>` : '';
          card.innerHTML = `
            <div class="habit-header">
              <h3>${habit.name}</h3>
              <div class="habit-actions">
                <button title="–í—ñ–¥–Ω–æ–≤–∏—Ç–∏" onclick="unarchiveHabit(${habit.habitId})">‚Ü©Ô∏è</button>
                <button title="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="deleteArchivedHabit(${habit.habitId})">üóëÔ∏è</button>
              </div>
            </div>
            <p>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${habit.category}</p>
            <p>üî• –û—Å—Ç–∞–Ω–Ω—ñ–π streak: <b>${habit.streak}</b> –¥–Ω—ñ–≤</p>
            <p>–í—Å—å–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–æ: ${habit.completionCount} —Ä–∞–∑(–∏)</p>
            ${repeatInfo}
            ${habit.note ? `<p>üìù –ù–æ—Ç–∞—Ç–∫–∞: ${habit.note}</p>` : ''}
            <p>üìÖ –ê—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ: <small>${new Date(habit.createdAt).toLocaleDateString('uk-UA')}</small></p>
          `;
          habitsList.appendChild(card);
        });
      }

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
      function updateAuthButtons() {
        const authButtons = document.getElementById("authButtons");
        authButtons.innerHTML = `
          <span class="user-greeting">–ü—Ä–∏–≤—ñ—Ç, ${currentUser.username}!</span>
          <a href="./profile.html" class="btn btn-outline">–ü—Ä–æ—Ñ—ñ–ª—å</a>
          <button onclick="authService.logout()" class="btn btn-fill">–í–∏–π—Ç–∏</button>
        `;
      }

      // –£—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      function showError(message) {
        const errorDiv = document.getElementById("errorMsg");
        if (!errorDiv) return;
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => {
          errorDiv.style.display = "none";
        }, 5000);
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("successMsg");
        if (!successDiv) return;
        successDiv.textContent = message;
        successDiv.style.display = "block";
        setTimeout(() => {
          successDiv.style.display = "none";
        }, 3000);
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const archiveList = document.getElementById("archiveList");
        let habits = JSON.parse(localStorage.getItem("habits")) || [];

        const saveHabits = () =>
          localStorage.setItem("habits", JSON.stringify(habits));

        const renderArchive = () => {
          archiveList.innerHTML = "";

          const archived = habits.filter((h) => h.archived);

          if (archived.length === 0) {
            archiveList.innerHTML = "<p>–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π üí§</p>";
            return;
          }

          archived.forEach((habit) => {
            const card = document.createElement("div");
            card.className = "habit-card glass";
            card.innerHTML = `
            <div class="habit-header">
              <h3>${habit.name}</h3>
              <div class="habit-actions">
                <button title="–í—ñ–¥–Ω–æ–≤–∏—Ç–∏" onclick="restoreHabit('${
                  habit.id
                }')">‚ôªÔ∏è</button>
                <button title="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="deleteHabit('${
                  habit.id
                }')">üóëÔ∏è</button>
              </div>
            </div>
            <p>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${habit.type}</p>
            <p>–¶—ñ–ª—å: ${habit.goal} —Ä–∞–∑—ñ–≤/—Ç–∏–∂–¥–µ–Ω—å</p>
            ${
              habit.complex
                ? `<p>–°–∫–ª–∞–¥–Ω–∞ –∑–≤–∏—á–∫–∞: ${habit.timesPerDay} —Ä–∞–∑(–∏) –Ω–∞ –¥–µ–Ω—å</p>`
                : ""
            }
          `;
            archiveList.appendChild(card);
          });
        };

        // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–≤–∏—á–∫—É
        window.restoreHabit = (id) => {
          const h = habits.find((h) => h.id === id);
          if (h) {
            h.archived = false;
            saveHabits();
            renderArchive();
            alert(`–ó–≤–∏—á–∫—É "${h.name}" –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ`);
          }
        };

        // –ü–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç–∏
        window.deleteHabit = (id) => {
          if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∑–≤–∏—á–∫—É –Ω–∞–∑–∞–≤–∂–¥–∏?")) {
            habits = habits.filter((h) => h.id !== id);
            saveHabits();
            renderArchive();
          }
        };

        renderArchive();
      });

      // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è / –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
      document.addEventListener("DOMContentLoaded", () => {
        const authButtons = document.getElementById("authButtons");

        if (authService.isAuthenticated()) {
          const user = authService.getCurrentUser();
          authButtons.innerHTML = `
          <span class="user-greeting">–ü—Ä–∏–≤—ñ—Ç, ${user.username}!</span>
          <a href="./profile.html" class="btn btn-outline">–ü—Ä–æ—Ñ—ñ–ª—å</a>
          <button onclick="authService.logout()" class="btn btn-fill">–í–∏–π—Ç–∏</button>
        `;
        } else {
          authButtons.innerHTML = `
          <a href="./login.html" class="btn btn-outline">–£–≤—ñ–π—Ç–∏</a>
          <a href="./register.html" class="btn btn-fill">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
        `;
        }
      });
    </script>
  </body>
</html>
